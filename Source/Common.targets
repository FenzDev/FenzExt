<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <PropertyGroup>
		<ReferencingProjectRoot>$(MSBuildProjectDirectory)</ReferencingProjectRoot>
    </PropertyGroup>

	<ItemGroup>
		<AvailableItemName Include="AssetsConfigFile" />
	</ItemGroup>
	
	<PropertyGroup>
		<IsThereLocalAssets Condition="$(AssetsSourcePath) != ''">True</IsThereLocalAssets>
		<IsThereLocalAssets Condition="$(AssetsSourcePath) == ''">False</IsThereLocalAssets>
		<AssetsSourceFullPath Condition="$(IsThereLocalAssets)">$(ReferencingProjectRoot)/$(AssetsSourcePath)</AssetsSourceFullPath>
	</PropertyGroup>
	
	<PropertyGroup>
		<DefaultAssetsConfigTargetPath>$(ReferencingProjectRoot)/AssetsConfig.json</DefaultAssetsConfigTargetPath>
		<AssetsConfigTemplatePath>$(MSBuildThisFileDirectory)AssetsConfig.json</AssetsConfigTemplatePath>	
		<BuildingToolDir>$(MSBuildThisFileDirectory)/Tools/</BuildingToolDir>
		<BuildingToolCommand>fwbuild</BuildingToolCommand>
		<MGCBAutoGeneratedFilePath>$(AssetsSourceFullPath)/.mgcref.cache</MGCBAutoGeneratedFilePath>
	</PropertyGroup>

	<Target Name="CheckConfigExistence" BeforeTargets="GenerateItems"
			Condition="'@(AssetsConfigFile)' == '' and $(IsThereLocalAssets)">
		
		<ItemGroup>
			<AssetsConfigFile Include="$(DefaultAssetsConfigTargetPath)"/>
        </ItemGroup>
		<Copy
			SourceFiles="$(AssetsConfigTemplatePath)"
			DestinationFiles="$(DefaultAssetsConfigTargetPath)" />
		<CallTarget Targets="GenerateAssetsInfo" />
    </Target>


	<Target Name="ErrorOnMultipleConfigs" Condition=" $([System.Int32]::Parse('@(AssetsConfigFile->Count())')) > 1 " >
		<Error Text="Can't have multiple AssetsConfig files!'"/>
    </Target>

	<Target Name="GenerateItems" BeforeTargets="RunBuildingTool">
		<ItemGroup>
			<LocalAssetDir Include="$(AssetsSourceFullPath)" />
			<LocalMGCBFile Include="$(MGCBAutoGeneratedFilePath)"/>
		</ItemGroup>
    </Target>
	
	<Target Name="RunBuildingTool" Condition="$(IsThereLocalAssets)">
	  <Exec 
			WorkingDirectory="$(ReferencingProjectRoot)"
			Command="&quot;$(BuildingToolCommand)&quot; &quot;%(AssetsConfigFile.Identity)&quot; &quot;@(LocalAssetDir->'%(FullPath)')&quot; &quot;@(LocalMGCBFile->'%(FullPath)')&quot;" />
	</Target>

	<Target Name="RunBuildingToolWithPlatform" Condition="'$(MonoGamePlatform)'!=''" BeforeTargets="CollectContentReferences">
		<CallTarget Condition="Exists($(AssetsSourceFullPath))" Targets="RunBuildingTool"/>
    </Target>

	<Target Name="RunBuildingToolNoPlatform" Condition="'$(MonoGamePlatform)'==''" BeforeTargets="Build">
		<CallTarget Condition="Exists($(AssetsSourceFullPath))" Targets="RunBuildingTool"/>
    </Target>

	<Target Name="IncludeAutoGeneratedMGCB" AfterTargets="RunBuildingTool">
		<ItemGroup>
			<MonoGameContentReference Include="@(FinalMGCBFile)"/>
        </ItemGroup>
    </Target>

	<Target Name="CleanAutoGeneratedMGCBRebuild" BeforeTargets="BeforeRebuild">
		<CallTarget Targets="CleanAutoGeneratedMGCB"/>
    </Target>
	<Target Name="CleanAutoGeneratedMGCBClean" BeforeTargets="Clean">
		<CallTarget Targets="CleanAutoGeneratedMGCB"/>
    </Target>

	<Target Name="CleanAutoGeneratedMGCB">
		<Delete Files="$(MGCBAutoGeneratedFilePath)"
				TreatErrorsAsWarnings="True"/>
		<Delete Files="$(AssetsSourceFullPath)/bin/**"
				TreatErrorsAsWarnings="True"/>
    </Target>

	<Target Name="CollectOtherProjectsContent" BeforeTargets="CollectContentReferences" Condition="'$(MonoGamePlatform)'!=''">
	  <!-- Create items from ProjectReference paths -->
	  <ItemGroup>
		<!-- Add metadata to project references if not already present -->
		<_ReferencedProjectDir Include="@(ProjectReference)">
		  <ProjectDir>$([System.IO.Path]::GetDirectoryName('%(Identity)'))</ProjectDir>
		</_ReferencedProjectDir>
	  </ItemGroup>

	  <ItemGroup>
		<!-- Use globbing to find .cache.mgcref in each reference -->
		<MonoGameContentReference Include="%( _ReferencedProjectDir.ProjectDir )\**\.mgcref.cache" />
	  </ItemGroup>
	</Target>

	
	<PropertyGroup>
		<AutoGenAssetsInfoFileName>Fenzwork._AutoGen.AssetsInfo.cs</AutoGenAssetsInfoFileName>
		<AssetsInfoWorkingDir Condition="'$(Configuration)'=='Debug' and $(IsThereLocalAssets)">$([MSBuild]::NormalizeDirectory($(AssetsSourceFullPath)).Replace("\", "/"))</AssetsInfoWorkingDir>
		<AssetsInfoWorkingDir Condition="'$(Configuration)'!='Debug' or !$(IsThereLocalAssets)"></AssetsInfoWorkingDir>
	</PropertyGroup>

	<Target Name="GenerateAssetsInfo" BeforeTargets="CoreCompile">
		<WriteLinesToFile
		  File="$(IntermediateOutputPath)$(AutoGenAssetsInfoFileName)"
		  Lines=' 
namespace Fenzwork._AutoGen.$(MSBuildProjectName)
{
	static class SetAssetsInfo
	{
		[System.Runtime.CompilerServices.ModuleInitializer]
		public static void Init() { Fenzwork.Services.ConstantsHelper.AddAssets("%(AssetsConfigFile.FullPath)", "$(AssetsInfoWorkingDir)")%3B }
	}
}'
		  Overwrite="true" />
		<ItemGroup>
			<Compile Include="$(IntermediateOutputPath)$(AutoGenAssetsInfoFileName)" AutoGen="true" />
		</ItemGroup>
	</Target>
	
	<Target Name="DeleteAssetsInfoClean"  BeforeTargets="Clean">
		<Delete Files="$(AutoGenAssetsInfoPath)" ContinueOnError="true"/>
    </Target>

	<Target Name="EnsureBuildingToolExists"  Condition=" !Exists('$(BuildingToolDir)$(BuildingToolCommand)') or !Exists('$(BuildingToolDir)$(BuildingToolCommand).exe')" BeforeTargets="Restore">
	    <MakeDir Directories="$(BuildingToolDir)"/>
	    <Exec Command="&quot;$(DotnetCommand)&quot; tool install fwbuild --tool-path ." WorkingDirectory="$(BuildingToolDir)" ContinueOnError="true" />
    </Target>


	<Import Project="Core.targets"/>

</Project>
