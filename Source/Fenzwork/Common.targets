<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
	  <AssetsConfigTargetPath>$(ReferencingProjectRoot)/AssetsConfig.json</AssetsConfigTargetPath>
	  <BuildingToolDir>$(MSBuildThisFileDirectory)../Fenzwork.BuildingTools/bin/$(Configuration)/net8.0</BuildingToolDir>
	  <BuildingToolPath>$(BuildingToolDir)/Fenzwork.BuildingTools.dll</BuildingToolPath>
	  <MGCBAutoGeneratedDirPath>$(ReferencingProjectRoot)/$(AssetsSourcePath)</MGCBAutoGeneratedDirPath>
	  <MGCBAutoGeneratedFilePath>$(MGCBAutoGeneratedDirPath)/.cache.$([System.IO.Path]::GetFileName($(AssetsSourcePath)))</MGCBAutoGeneratedFilePath>
	</PropertyGroup>
	
	<PropertyGroup>
		<AssetsSourceFullPath>$(ReferencingProjectRoot)/$(AssetsSourcePath)</AssetsSourceFullPath>
	</PropertyGroup>

	<PropertyGroup Condition="'$(AssetsSourcePath)'==''">
		<AssetsSourcePath>Content</AssetsSourcePath>
	</PropertyGroup>

	<Target Name="EnsureJsonFileCopied" BeforeTargets="BeforeBuild">
		<PropertyGroup>
			<AssetsConfigTemplatePath>$(MSBuildThisFileDirectory)AssetsConfig.json</AssetsConfigTemplatePath>	
        </PropertyGroup>
      <Copy
        Condition="!Exists('$(AssetsConfigTargetPath)')"
        SourceFiles="$(AssetsConfigTemplatePath)"
        DestinationFiles="$(AssetsConfigTargetPath)" />
	</Target>

	<Target Name="GenerateItems" BeforeTargets="RunBuildingTool">
		<ItemGroup >
			<FinalAssetDir Include="$(AssetsSourceFullPath)" />
			<FinalConfigFile Include="$(AssetsConfigTargetPath)" />
			<FinalMGCBFile Include="$(MGCBAutoGeneratedFilePath)"/>
		</ItemGroup>
		<Message Text="WTF" Importance="High"/>
    </Target>

	<Target Name="RunBuildingTool" BeforeTargets="CollectContentReferences">
	  <Exec 
			  WorkingDirectory="$(ReferencingProjectRoot)"
			  Command="dotnet &quot;$(BuildingToolPath)&quot; &quot;@(FinalConfigFile->'%(FullPath)')&quot; &quot;@(FinalAssetDir->'%(FullPath)')&quot; &quot;@(FinalMGCBFile->'%(FullPath)')&quot;" />
      
	</Target>

	<Target Name="IncludeAutoGeneratedMGCB" AfterTargets="RunBuildingTool">
		<ItemGroup>
			<MonoGameContentReference Include="@(FinalMGCBFile)"/>
        </ItemGroup>
    </Target>

	<Target Name="CleanAutoGeneratedMGCB" BeforeTargets="Clean">
		<Delete Files="$(MGCBAutoGeneratedFilePath)"
				TreatErrorsAsWarnings="True"/>
    </Target>


</Project>
